integer canal = 3141;
list avatares = [];

integer listenChannel = 3143;
integer listenHandle;

reportar_movimiento(key registro){
    llRegionSay( canal, ((string)registro) + " mueve" );
    if( registro != llGetOwner() ){
        // llSay( 0, llKey2Name(registro) + " mueve" );
    }    
}

remove_listen_handle(){
    llListenRemove(listenHandle);
}

string avatar2json(key avatar, vector posicion){
    return "{\"id\":\""+((string) avatar)+"\",\"pos\":\""+((string) posicion)+"\"}";
}
 
registrar_posicion(key avatar, vector posicion){
    integer tamano = llGetListLength(avatares);
    string registro = avatar2json(avatar,posicion);
    integer indice = -1;
    integer i;
    for( i = 0; i < tamano ; i++ ){
        string dato = llList2String(avatares, i);
        if( ((string)avatar) == llJsonGetValue(dato,["id"]) ){
            indice = i;
            if( ((string)posicion) != llJsonGetValue(dato,["pos"]) ){
                avatares = llListReplaceList(avatares , [ registro ], i, i);
                reportar_movimiento( avatar);
            }
            // provoca un break
            i = tamano;
        }
    }
    if(indice < 0){
        avatares += registro;
        //reportar_movimiento(registro);
        //llOwnerSay("Numero Avatares: " + (string)llGetListLength(avatares) );
    }
    
}

default
{
    state_entry()
    {
        avatares = [];
        listenHandle = llListen(listenChannel,"",NULL_KEY,"jugar_calamar");
        llSay(0,"Plataforma reiniciada");
    }
    state_exit(){
        remove_listen_handle();
    }
    collision(integer num_detected){
        integer i;
        //llSay(0,"" + (string)num_detected + " colisiones detectadas");
        for(i = 0; i < num_detected ; i++){
            registrar_posicion(llDetectedKey(i), llDetectedPos(i) );
        }         
    }
    listen(integer channel, string name, key id, string msg)
    {
        if (msg != "")
        {
            list commands = llParseString2List(msg, [ " " ], []);
            string msg0 = llList2String(commands, 0);
            string msg1 = llList2String(commands, 1);            
            string msg2 = llList2String(commands, 2);
            string msg3 = llList2String(commands, 3);
 
            if (msg0 == "jugar_calamar")
            {
                llResetScript( );
            }
        }   
    }   
}